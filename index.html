<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Corine â€“ multi dataset & palette</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.33/"></script>
<!-- Nuovo componente per basemap gallery -->
<script type="module" src="https://js.arcgis.com/map-components/4.33/arcgis-basemap-gallery.js"></script>
<style>
  html,body,#viewDiv{height:100%;margin:0}
  #panel{
    position:absolute;top:10px;left:10px;z-index:10;background:#fff;padding:12px;border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.15);font-family:system-ui,sans-serif;font-size:14px;
    max-width:420px;max-height:92%;overflow:auto
  }
  .row{display:flex;gap:8px;align-items:center;margin:.35rem 0}
  .card{border:1px solid #e5e7eb;border-radius:8px;background:#fafafa;padding:8px;margin-top:8px}
  .card h4{margin:.2rem 0 .5rem 0;font-size:14px}
  .muted{color:#666}
  .ok{color:#166534}
  .err{color:#b91c1c}
  #log{font-size:12px;max-height:140px;overflow:auto;margin-top:6px}
  arcgis-basemap-gallery {
    position: absolute;
    bottom: 15px;
    right: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.25);
  }
</style>
</head>
<body>
<div id="viewDiv"></div>

<!-- nuovo widget basemap -->
<arcgis-basemap-gallery position="bottom-right"></arcgis-basemap-gallery>

<div id="panel">
  <div class="row"><strong>Dati GeoJSON</strong></div>
  <div class="row">
    <button id="btnLoadDefault">Carica default</button>
    <input id="urlInput" class="grow" type="text" placeholder="./nomefile.geojson o URL stessa origine">
    <button id="btnAddUrl">Aggiungi URL</button>
  </div>
  <div class="row">
    <input id="fileInput" type="file" accept=".geojson" multiple>
    <span class="muted">oppure file locale</span>
  </div>

  <hr>
  <div class="row"><strong>Palette</strong></div>
  <div class="row">
    <button id="btnAutoPal">Auto-carica</button>
    <input id="palFile" type="file" accept=".json">
    <button id="btnLoadPal">Carica da file</button>
  </div>
  <div id="palInfo" class="muted"></div>

  <hr>
  <div><strong>Layer caricati</strong></div>
  <div id="layersWrap"></div>

  <hr>
  <div><strong>Log</strong></div>
  <div id="log"></div>
</div>

<script>
require([
  "esri/Map","esri/views/MapView","esri/layers/GeoJSONLayer","esri/renderers/UniqueValueRenderer","esri/symbols/SimpleFillSymbol"
],(Map,MapView,GeoJSONLayer,UniqueValueRenderer,SimpleFillSymbol)=>{

  const map = new Map({ basemap:"gray-vector" });
  const view = new MapView({ container:"viewDiv", map, center:[-8,39.5], zoom:6 });
  view.ui.move("zoom","top-right");

  let PALETTES = {};
  const FALLBACK = {
    "1":"#a35a16","2":"#7d3f10","3":"#f1b837","4":"#312914","5":"#805835",
    "6":"#d3b04c","7":"#2e110d","8":"#cd6b14","9":"#6a6548","10":"#7f6d2d",
    "11":"#644600","12":"#52461e","13":"#e39226","14":"#973613","15":"#6c2415",
    "16":"#ffdf5a","17":"#0f0506","18":"#a58936","19":"#606d35","20":"#4d2212"
  };
  const LAYERS = [];

  function log(msg,cls=""){ 
    const div=document.getElementById("log");
    const p=document.createElement("div"); if(cls) p.className=cls;
    p.textContent=msg; div.appendChild(p); div.scrollTop=div.scrollHeight;
  }

  function normalizePalettes(obj) {
    const out = {};
    if (Array.isArray(obj?.palettes)) {
      obj.palettes.forEach(p => {
        const name = p.name || "Senza nome";
        const colors = {};
        for (let i=1;i<=20;i++) colors[String(i)] = p.colors?.[String(i)] || FALLBACK[String(i)];
        out[name] = { name, colors };
      });
    } else {
      Object.entries(obj || {}).forEach(([name, p]) => {
        if (!p?.colors) return;
        const colors = {};
        for (let i=1;i<=20;i++) colors[String(i)] = p.colors?.[String(i)] || FALLBACK[String(i)];
        out[name] = { name, colors };
      });
    }
    return out;
  }

  async function autoLoadPalettes() {
    const palInfo = document.getElementById("palInfo");
    try {
      const r = await fetch("./palettes_from_twb.json",{cache:"no-store"});
      if(!r.ok) throw "not found";
      const data = await r.json();
      PALETTES = normalizePalettes(data);
      palInfo.textContent = `Palette caricate: ${Object.keys(PALETTES).length}`;
      log("Palette caricate","ok");
      refreshLayerCards();
    } catch(e){
      palInfo.textContent="Nessuna palette trovata";
      log("Palette non trovate","err");
    }
  }

  function addLayer(url,name){
    const renderer = new UniqueValueRenderer({
      field:"group",
      defaultSymbol:new SimpleFillSymbol({color:[200,200,200,0.5],outline:{color:"gray",width:0.3}})
    });
    const layer = new GeoJSONLayer({
      url,
      title: name || url.split("/").pop(),
      renderer
    });
    map.add(layer);
    LAYERS.push(layer);
    log(`Layer aggiunto: ${layer.title}`,"ok");
    refreshLayerCards();
  }

  function refreshLayerCards(){
    const wrap=document.getElementById("layersWrap");
    wrap.innerHTML="";
    LAYERS.forEach(layer=>{
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`<h4>${layer.title}</h4>`;
      const sel=document.createElement("select");
      Object.keys(PALETTES).forEach(name=>{
        const opt=document.createElement("option");
        opt.value=name; opt.textContent=name;
        sel.appendChild(opt);
      });
      sel.addEventListener("change",()=>{
        applyPalette(layer,PALETTES[sel.value]);
      });
      card.appendChild(sel);
      wrap.appendChild(card);
    });
  }

  function applyPalette(layer,palette){
    if(!palette){log("Nessuna palette selezionata","err");return;}
    const colors=palette.colors;
    const renderer = new UniqueValueRenderer({
      field:"group",
      defaultSymbol:new SimpleFillSymbol({color:[220,220,220,0.4],outline:{color:"gray",width:0.3}}),
      uniqueValueInfos:Object.entries(colors).map(([k,v])=>({
        value:k,
        symbol:new SimpleFillSymbol({color:v,outline:{color:"black",width:0.2}})
      }))
    });
    layer.renderer=renderer;
    log(`Palette applicata a ${layer.title}: ${palette.name}`,"ok");
  }

  // bottoni
  document.getElementById("btnLoadDefault").addEventListener("click",()=>{
    addLayer("./CLC2012_Export_FeaturesToJSO.geojson","Corine (default)");
  });
  document.getElementById("btnAddUrl").addEventListener("click",()=>{
    const url=document.getElementById("urlInput").value.trim();
    if(url) addLayer(url);
  });
  document.getElementById("fileInput").addEventListener("change",evt=>{
    [...evt.target.files].forEach(f=>{
      const url=URL.createObjectURL(f);
      addLayer(url,f.name);
    });
  });
  document.getElementById("btnAutoPal").addEventListener("click",autoLoadPalettes);
  document.getElementById("btnLoadPal").addEventListener("click",async()=>{
    const input=document.getElementById("palFile");
    if(!input.files[0]) return;
    try{
      const txt=await input.files[0].text();
      PALETTES=normalizePalettes(JSON.parse(txt));
      document.getElementById("palInfo").textContent=`Palette caricate: ${Object.keys(PALETTES).length}`;
      log("Palette caricate da file","ok");
      refreshLayerCards();
    }catch(e){log("Errore JSON palette","err");}
  });

  autoLoadPalettes();
});
</script>
</body>
</html>
