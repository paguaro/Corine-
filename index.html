<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Corine Land Cover – Palette da quadri</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.33/"></script>
  <style>
    html, body, #viewDiv { height:100%; margin:0; padding:0; }
    #panel {
      position:absolute; top:10px; left:10px; z-index:10;
      background:#fff; padding:12px; border-radius:8px;
      font-family:system-ui,sans-serif; font-size:13px;
      box-shadow:0 2px 8px rgba(0,0,0,.25); min-width:280px;
    }
    #panel h3 { margin:0 0 8px; font-size:14px; }
    #log { max-height:120px; overflow:auto; font-size:12px; }
    .ok { color:#166534; }
    .err { color:#b91c1c; }
    select, button, input { margin-top:4px; font-size:13px; }
  </style>
</head>
<body>
<div id="viewDiv"></div>

<div id="panel">
  <h3>Controlli</h3>
  <div>
    <label>Palette:
      <select id="paletteSelect"></select>
    </label>
  </div>
  <div class="row">
    <input id="palFile" type="file" accept=".json" />
    <button id="btnLoadPal">Carica palette</button>
  </div>
  <div id="palInfo" style="margin:4px 0; font-size:12px; color:#555;"></div>
  <hr>
  <div id="log"></div>
</div>

<script>
const GEOJSON_PATH = "./CLC2012_Export_FeaturesToJSO.geojson";

// fallback palette (Gioconda ridotta a 20 colori)
const FALLBACK = {
  "1":"#a35a16","2":"#7d3f10","3":"#f1b837","4":"#312914","5":"#805835",
  "6":"#d3b04c","7":"#2e110d","8":"#cd6b14","9":"#6a6548","10":"#7f6d2d",
  "11":"#644600","12":"#52461e","13":"#e39226","14":"#973613","15":"#6c2415",
  "16":"#ffdf5a","17":"#0f0506","18":"#a58936","19":"#606d35","20":"#4d2212"
};

let PALETTES = { "Default": { name:"Default", colors: FALLBACK } };
let activePalette = "Default";
let layer;

const log = (msg, cls="") => {
  const div = document.getElementById("log");
  div.innerHTML = `<div class="${cls}">${msg}</div>` + div.innerHTML;
};

// Funzione: normalizza JSON palette
function normalizePalettes(obj) {
  const out = {};
  if (Array.isArray(obj?.palettes)) {
    obj.palettes.forEach(p => {
      const name = p.name || "Senza nome";
      const colors = {};
      for (let i=1;i<=20;i++) colors[String(i)] = p.colors?.[String(i)] || FALLBACK[String(i)];
      out[name] = { name, colors };
    });
  } else {
    Object.entries(obj || {}).forEach(([name, p]) => {
      if (!p?.colors) return;
      const colors = {};
      for (let i=1;i<=20;i++) colors[String(i)] = p.colors?.[String(i)] || FALLBACK[String(i)];
      out[name] = { name, colors };
    });
  }
  return out;
}

// Prova caricare palette da file noto
async function autoLoadPalettes() {
  const palInfo = document.getElementById("palInfo");
  const candidates = [
    "./palettes_from_twb.json",
    "./palettes.json",
    "./data/palettes_from_twb.json"
  ];
  for (const url of candidates) {
    try {
      const r = await fetch(url, { cache:"no-store" });
      if (!r.ok) continue;
      const data = await r.json();
      PALETTES = normalizePalettes(data);
      palInfo.textContent = `Palette caricate da ${url} (${Object.keys(PALETTES).length})`;
      refreshPaletteSelect();
      return;
    } catch(e) { /* continua */ }
  }
  palInfo.textContent = "Nessuna palette trovata. Uso fallback.";
  refreshPaletteSelect();
}

// Popola la tendina palette
function refreshPaletteSelect() {
  const sel = document.getElementById("paletteSelect");
  sel.innerHTML = "";
  Object.keys(PALETTES).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name; opt.textContent = name;
    sel.appendChild(opt);
  });
  sel.value = activePalette;
  applyRenderer();
}

// Cambia renderer con la palette attiva
function applyRenderer() {
  if (!layer) return;
  const pal = PALETTES[activePalette] || PALETTES["Default"];
  const renderer = {
    type: "unique-value",
    field: "group",
    uniqueValueInfos: []
  };
  for (let i=1;i<=20;i++) {
    renderer.uniqueValueInfos.push({
      value: i.toString(),
      symbol: {
        type: "simple-fill",
        color: pal.colors[i],
        outline: { width: 0.1, color: [50,50,50,0.4] }
      },
      label: `Classe ${i}`
    });
  }
  layer.renderer = renderer;
}

// Esri JS load
require(["esri/Map","esri/views/MapView","esri/layers/GeoJSONLayer"], (Map,MapView,GeoJSONLayer) => {
  const map = new Map({ basemap:"gray-vector" });
  const view = new MapView({ container:"viewDiv", map, center:[-8,39.5], zoom:6 });

  // GeoJSONLayer da fetch -> Blob
  fetch(GEOJSON_PATH,{cache:"no-store"}).then(async r=>{
    if(!r.ok) throw new Error("GeoJSON non trovato");
    const obj = await r.json();
    const blob = new Blob([JSON.stringify(obj)],{type:"application/json"});
    const url = URL.createObjectURL(blob);

    layer = new GeoJSONLayer({ url, title:"CLC (20 gruppi)", outFields:["*"] });
    map.add(layer);

    layer.when(()=>{
      log("GeoJSON caricato ✔️","ok");
      applyRenderer();
      layer.queryExtent().then(res=>{ if(res.extent) view.goTo(res.extent.expand(1.1)); });
    }).catch(e=>log("Errore layer: "+e.message,"err"));
  }).catch(e=>log("Fetch error: "+e.message,"err"));

  // Eventi UI
  document.getElementById("paletteSelect").addEventListener("change", e=>{
    activePalette = e.target.value;
    applyRenderer();
  });

  document.getElementById("btnLoadPal").addEventListener("click", async ()=>{
    const f = document.getElementById("palFile").files[0];
    if(!f) { alert("Seleziona un file JSON"); return; }
    try {
      const txt = await f.text();
      const data = JSON.parse(txt);
      PALETTES = normalizePalettes(data);
      document.getElementById("palInfo").textContent =
        `Palette caricate da file (${Object.keys(PALETTES).length})`;
      refreshPaletteSelect();
    } catch(e) { alert("File JSON non valido"); }
  });

  autoLoadPalettes();
});
</script>
</body>
</html>
