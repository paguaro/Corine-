<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>CLC2018 → Palette d’autore</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css" />
<script src="https://js.arcgis.com/4.33/"></script>
<style>
  html,body,#viewDiv{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .panel{position:absolute;top:10px;left:10px;z-index:10;background:#fffeb;border-radius:10px;padding:10px;width:420px;box-shadow:0 2px 10px rgba(0,0,0,.15);font-size:14px}
  .row{display:flex;gap:6px;margin:6px 0;align-items:center}
  .row label{min-width:110px}
  textarea{width:100%;height:120px;font:12px ui-monospace,Menlo,Consolas,monospace}
  #legend{position:absolute;right:10px;bottom:10px;z-index:10;background:#fff;border-radius:8px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:12px;max-width:280px}
  .legend-item{display:flex;gap:8px;align-items:center;margin:4px 0}
  .sw{width:14px;height:14px;border:1px solid #0003;border-radius:2px}
  #log{font:12px ui-monospace,monospace;background:#fafafa;border:1px solid #eee;border-radius:6px;max-height:140px;overflow:auto;white-space:pre-wrap;padding:6px}
</style>
</head>
<body>
<div id="viewDiv"></div>

<div class="panel">
  <div><strong>CLC2018 → Palette d’autore</strong></div>

  <div class="row">
    <label>Layer URL</label>
    <input id="layerUrl" style="flex:1"
      value="https://image.discomap.eea.europa.eu/arcgis/rest/services/Corine/CLC2018_WM/MapServer/0" />
  </div>
  <div class="row">
    <label>Campo classe</label>
    <input id="classField" style="flex:1" value="Code_18" />
  </div>

  <div class="row">
    <label>JSON palette</label>
    <button id="btnDemo">Demo</button>
    <button id="btnFromUrl">Da URL</button>
  </div>
  <div class="row"><textarea id="paletteJson" placeholder='Incolla qui il JSON delle palette…'></textarea></div>
  <div class="row">
    <label>Palette</label>
    <select id="paletteSelect" style="flex:1"><option value="">— carica JSON —</option></select>
  </div>

  <div class="row">
    <button id="btnApply">Calcola & Applica</button>
    <button id="btnShot">Esporta PNG</button>
  </div>
  <div id="log"></div>
</div>

<div id="legend" hidden>
  <div><strong>Legenda (prime 25)</strong></div>
  <div id="legendItems"></div>
</div>

<script>
require([
  "esri/Map","esri/views/MapView","esri/layers/FeatureLayer",
  "esri/geometry/geometryEngine","esri/widgets/ScaleBar"
], (Map,MapView,FeatureLayer,geometryEngine,ScaleBar) => {

  const logEl = document.getElementById("log");
  function log(m){ logEl.textContent += m+"\\n"; logEl.scrollTop = logEl.scrollHeight; }

  const map = new Map({ basemap: "gray-vector" });
  const view = new MapView({ container: "viewDiv", map, center: [-8,39.6], zoom: 6 });
  view.ui.add(new ScaleBar({ view, unit: "metric" }), "bottom-left");

  let fl = null;

  // Demo palette
  document.getElementById("btnDemo").onclick = () => {
    const demo = {
      "van_gogh_starry_night":{ "title":"Van Gogh – Starry Night",
        "colors":[{"hex":"#2C3E50","weight":35},{"hex":"#2980B9","weight":30},{"hex":"#F1C40F","weight":20},{"hex":"#27AE60","weight":10},{"hex":"#ECF0F1","weight":5}]},
      "monet_water_lilies":{ "title":"Monet – Water Lilies",
        "colors":[{"hex":"#567D46","weight":40},{"hex":"#7FB3D5","weight":25},{"hex":"#D4E6F1","weight":15},{"hex":"#A9DFBF","weight":12},{"hex":"#1B4F72","weight":8}]}
    };
    paletteJson.value = JSON.stringify(demo,null,2);
    populatePaletteSelect(demo);
    log("Palette demo caricate.");
  };

  document.getElementById("btnFromUrl").onclick = async () => {
    const url = prompt("URL JSON palette:");
    if(!url) return;
    const obj = await (await fetch(url)).json();
    paletteJson.value = JSON.stringify(obj,null,2);
    populatePaletteSelect(obj);
    log("Palette caricate da URL.");
  };

  function populatePaletteSelect(obj){
    const sel = document.getElementById("paletteSelect");
    sel.innerHTML = "<option value=''>— seleziona —</option>";
    for(const [k,v] of Object.entries(obj)) sel.append(new Option(v.title||k,k));
  }

  document.getElementById("btnApply").onclick = async () => {
    try{
      logEl.textContent = "";
      const url = document.getElementById("layerUrl").value.trim();
      const classField = document.getElementById("classField").value.trim();
      const paletteObj = JSON.parse(document.getElementById("paletteJson").value || "{}");
      const paletteKey = document.getElementById("paletteSelect").value;
      if(!url || !classField || !paletteObj[paletteKey]){ alert("Compila URL, campo classe e palette."); return; }

      // Crea FeatureLayer sul servizio EEA
      if(fl) map.remove(fl);
      fl = new FeatureLayer({ url, outFields: ["*"], title: "CLC2018" });
      map.add(fl);
      await fl.load();
      log("Layer caricato.");

      // 1) Provo server-side: somma area per classe (Shape_Area) con groupBy
      let classAreas = null;
      try{
        log("Calcolo aree per classe (server)…");
        const statDef = [{ onStatisticField: "Shape_Area", outStatisticFieldName: "sum_area", statisticType: "sum" }];
        const res = await fl.queryFeatures({
          where: "1=1",
          outFields: [classField],
          groupByFieldsForStatistics: [classField],
          outStatistics: statDef,
          returnGeometry: false
        });
        classAreas = {};
        res.features.forEach(f => {
          const cls = String(f.attributes[classField]);
          const a = +f.attributes.sum_area || 0;
          classAreas[cls] = (classAreas[cls]||0) + a;
        });
        if(Object.keys(classAreas).length === 0) throw new Error("no_stats");
        log(`Statistiche server OK: ${Object.keys(classAreas).length} classi.`);
      } catch(e){
        // 2) Fallback client: pagino le features e sommo geodesicArea
        log("Statistiche non disponibili → fallback client (può essere più lento) …");
        classAreas = await computeAreasClient(fl, classField);
        log(`Aree client calcolate: ${Object.keys(classAreas).length} classi.`);
      }

      const totalArea = Object.values(classAreas).reduce((a,b)=>a+b,0);
      log(`Area totale ≈ ${fmtArea(totalArea)}.`);

      // Palette normalizzata e ordinamento classi per area
      const palette = normalizePalette(paletteObj[paletteKey].colors);
      const classOrder = Object.entries(classAreas).sort((a,b)=>b[1]-a[1]).map(([k])=>k);

      // Assegnazione proporzionale
      const classToColor = assignColorsByArea(classOrder, classAreas, palette);

      // Applica renderer
      fl.renderer = {
        type: "unique-value",
        field: classField,
        uniqueValueInfos: Object.entries(classToColor).map(([value, hex]) => ({
          value, label: value,
          symbol: { type: "simple-fill", color: hex, outline: { color: [0,0,0,40], width: 0.25 } }
        }))
      };

      // Zoom estensione
      const ext = await fl.queryExtent();
      if(ext && ext.extent) view.goTo(ext.extent.expand(1.05));

      renderLegend(Object.entries(classToColor).map(([value,hex])=>({value,label:value,symbol:{color:hex}})));
      log("Palette applicata con proporzioni del quadro. ✅");

    } catch(err){ console.error(err); alert("Errore: "+err.message); }
  };

  document.getElementById("btnShot").onclick = async () => {
    const shot = await view.takeScreenshot({ format:"png", quality:100 });
    const a = document.createElement("a"); a.href = shot.dataUrl; a.download = "clc2018_palette.png"; a.click();
  };

  // --- Helpers ---
  async function computeAreasClient(layer, classField){
    const out = {};
    const pageSize = 5000;
    let num = 0, start = 0;
    // prima conto
    const count = await layer.queryFeatureCount();
    while(start < count){
      const res = await layer.queryFeatures({ where:"1=1", outFields:[classField], returnGeometry:true, start, num:pageSize });
      res.features.forEach(f=>{
        const cls = String(f.attributes[classField]);
        let a = 0;
        try{ a = Math.abs(geometryEngine.geodesicArea(f.geometry,"square-meters")); }catch(e){ a = 0; }
        out[cls] = (out[cls]||0) + (isFinite(a)?a:0);
      });
      num += res.features.length;
      log(`  • Batch ${start+1}–${start+res.features.length} (tot: ${num})`);
      if(res.features.length === 0) break;
      start += res.features.length;
      await new Promise(r=>setTimeout(r,0));
    }
    return out;
  }

  function normalizePalette(colors){
    const sum = colors.reduce((s,c)=>s+(+c.weight||0),0)||1;
    return colors.map(c=>({hex:c.hex,w:(c.weight||0)*100/sum}));
  }

  function assignColorsByArea(classOrder, classAreas, palette){
    const total = Object.values(classAreas).reduce((a,b)=>a+b,0);
    const buckets = palette.map(p=>({hex:p.hex,target:p.w/100*total,assigned:0}));
    const mapColor = {};
    let i=0;
    for(const cls of classOrder){
      const a = classAreas[cls];
      while(i < buckets.length-1 && buckets[i].assigned + a > buckets[i].target*1.02) i++;
      mapColor[cls] = buckets[i].hex;
      buckets[i].assigned += a;
    }
    return mapColor;
  }

  function renderLegend(infos){
    const leg = document.getElementById("legend");
    const box = document.getElementById("legendItems");
    box.innerHTML = ""; leg.hidden = false;
    infos.slice(0,25).forEach(inf=>{
      const d=document.createElement("div"); d.className="legend-item";
      const s=document.createElement("span"); s.className="sw"; s.style.background = Array.isArray(inf.symbol.color)
        ? `rgba(${inf.symbol.color[0]},${inf.symbol.color[1]},${inf.symbol.color[2]},${(inf.symbol.color[3]??255)/255})`
        : inf.symbol.color;
      const t=document.createElement("span"); t.textContent = inf.label || inf.value;
      d.append(s,t); box.append(d);
    });
  }

  function fmtArea(m2){
    if(m2>1e8) return (m2/1e6).toFixed(1)+" km²";
    if(m2>1e6) return (m2/1e6).toFixed(2)+" km²";
    return m2.toLocaleString("it-IT")+" m²";
  }
});
</script>
</body>
</html>