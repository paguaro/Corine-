<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Corine ‚Äî Layer, Palette & Presenter</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.33/"></script>

<script type="module">
  import * as topojson from "https://cdn.jsdelivr.net/npm/topojson-client@3/+esm";
  window.topojsonClient = topojson;
</script>

<style>
  :root{--r:12px;--shadow:0 6px 18px rgba(0,0,0,.22);--btn:#f4f4f5;--btnh:#ececee;--muted:#666}
  html,body,#viewDiv{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  #viewDiv{position:absolute;inset:0}
  .esri-view .esri-view-surface{background-color:transparent}

  #panel{position:absolute;top:12px;left:12px;z-index:30;width:420px;max-height:88vh;overflow:auto;
    background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:10px}
  #panel.collapsed{display:none}
  #panelToggle{position:absolute;top:12px;left:12px;z-index:31;width:40px;height:40px;border:none;border-radius:10px;
    background:var(--btn);box-shadow:var(--shadow);cursor:pointer;font-size:18px}
  .row{display:flex;gap:8px;align-items:center;margin:.45rem 0}
  .grow{flex:1}.muted{color:var(--muted);font-size:12px}
  button,select,input{font:inherit}
  .chip{padding:4px 8px;border-radius:999px;background:var(--btn);border:1px solid #e5e5e5}
  .chip:hover{background:var(--btnh)}

  #serverWrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:6px}
  .srv{display:flex;align-items:center;gap:6px;border:1px solid #e7e7e7;border-radius:9px;padding:6px;background:#fff}
  .srv label{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .card{border:1px solid #ececec;border-radius:10px;padding:8px;background:#fafafa;margin-top:8px}
  .card h5{margin:0 0 6px 0;font-size:13px}
  .swatch{display:inline-block;width:16px;height:16px;border:1px solid #ccc;margin-left:2px;border-radius:3px}

  #palSidebar{position:absolute;top:12px;right:12px;z-index:30;display:flex;flex-direction:column;
    width:min(18vw,360px);min-width:280px;max-height:calc(100vh - 120px);
    resize:both;overflow:hidden;background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:10px}
  #palSidebar.collapsed{display:none}
  #palToggle{position:absolute;top:110px;right:12px;z-index:31;height:40px;padding:0 10px;border:none;border-radius:10px;
    background:var(--btn);box-shadow:var(--shadow);cursor:pointer}
  #palHeader{cursor:move;user-select:none;display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
  #palGallery{flex:1;overflow:auto}
  #palGallery .pal{border:1px solid #eee;border-radius:10px;padding:8px;margin-bottom:8px;background:#fff;cursor:pointer}
  .pal-top{display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:11px}
  .pal-links a{font-size:14px;text-decoration:none;opacity:.85;margin-left:6px}
  .pal-links a:hover{opacity:1}
  .sw10{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:6px}
  .sw{height:16px;border-radius:3px;border:1px solid #ddd}

  .dockC{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;z-index:40;display:flex;gap:8px}
  .pill{border:none;border-radius:999px;padding:10px 14px;background:var(--btn);box-shadow:var(--shadow);cursor:pointer}
  .pill:hover{background:var(--btnh)}
  .esri-ui-bottom-right{margin:12px}

  #ssPanel{position:absolute;left:50%;transform:translateX(-50%);bottom:64px;z-index:41;min-width:330px;max-width:92vw;
    background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:10px;display:none}
  #ssPanel .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
  #ssPanel.show{display:block}
  #ssPanel .row{margin:.3rem 0}
  #ssPanel label{font-size:12px;color:#444}
  #ssPanel input[type=range]{flex:1}
  #ssPanel span.val{min-width:90px;text-align:right;font-size:12px;color:#333}

  #toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:6px 14px;
    border-radius:20px;font-size:13px;opacity:0;transition:opacity .3s;z-index:99}
  #toast.show{opacity:1}

  @media (max-width:980px){
    #panel{width:92vw}
    #palSidebar{width:calc(100vw - 24px);left:12px;min-width:auto}
  }
</style>
</head>
<body>
<div id="viewDiv"></div>

<button id="panelToggle" title="Mostra/Nascondi pannello">‚ò∞</button>
<button id="palToggle" title="Palette">üé® Palette</button>

<div id="panel">
  <div class="row" style="justify-content:space-between">
    <strong style="margin-left:40px">Layer & file</strong>
    <span class="muted">legenda per-layer ‚Ä¢ palette per-layer</span>
  </div>
  <h4 style="margin:.3rem 0 .5rem 0;font-size:14px">Layer sul server</h4>
  <div id="serverWrap"></div>
  <div class="row">
    <button id="btnLoadSelected" class="chip">Carica selezionati</button>
    <button id="btnLoadAll" class="chip">Carica tutti</button>
    <span class="muted grow" style="text-align:right">oppure file locali‚Ä¶</span>
  </div>
  <div class="row"><input id="fileInput" class="grow" type="file" accept=".topojson,.geojson,.json" multiple></div>
  <h4 style="margin-top:10px">Layer caricati</h4>
  <div id="layersWrap"></div>
</div>

<div id="palSidebar" class="collapsed">
  <div id="palHeader">
    <h4 style="margin:0">Palette</h4>
    <button id="palClose" class="chip" title="Chiudi">‚úñ</button>
  </div>
  <div class="muted">clic per applicare</div>
  <div id="palGallery"></div>
</div>

<div class="dockC">
  <button id="btnDayNight" class="pill" title="Sfondo">üåì</button>
  <input id="bgColor" type="color" value="#111111" title="Colore sfondo" class="pill" style="width:48px;height:40px;padding:6px 8px">
  <button id="btnShow" class="pill" title="Slideshow on/off">üéûÔ∏è</button>
  <button id="btnShuffleGlobal" class="pill" title="Rimescola linkato">üé≤</button>
  <button id="btnExport" class="pill" title="Esporta PNG">üì∏</button>
  <button id="btnSSSettings" class="pill" title="Impostazioni slideshow">‚öôÔ∏è</button>
  <button id="btnCopyLink" class="pill" title="Copia link presentazione">üì§</button>
</div>

<div id="ssPanel" aria-live="polite">
  <div style="font-weight:600;margin-bottom:6px">Slideshow ‚Äî Impostazioni</div>
  <div class="row"><label class="grow"><input type="checkbox" id="ssNewWin"> Apri in nuova finestra (Presenter)</label></div>
  <div class="row"><label class="grow">Intervallo minimo (sec)</label><input type="range" id="ssIntMin" min="5" max="120" value="30"><span id="ssIntMinVal" class="val">30 s</span></div>
  <div class="row"><label class="grow">Intervallo massimo (sec)</label><input type="range" id="ssIntMax" min="5" max="120" value="60"><span id="ssIntMaxVal" class="val">60 s</span></div>
  <div class="row"><label class="grow">Scala minima (1:n)</label><input type="range" id="ssScaleMin" min="5000" max="100000" step="1000" value="25000"><span id="ssScaleMinVal" class="val">25k</span></div>
  <div class="row"><label class="grow">Scala massima (1:n)</label><input type="range" id="ssScaleMax" min="5000" max="100000" step="1000" value="50000"><span id="ssScaleMaxVal" class="val">50k</span></div>
  <div class="row"><label class="grow"><input type="checkbox" id="ssRandZone" checked> Zone random</label></div>
  <div class="actions"><button id="ssCancel" class="chip">Chiudi</button><button id="ssStart" class="chip">Avvia</button></div>
</div>

<div id="toast">Link copiato!</div>

<script>
/* ... [JS invariato rispetto alla tua versione precedente, solo AGGIUNTA la parte CopyLink e Toast] ... */

// Bottone üì§ copia link
document.getElementById("btnCopyLink").onclick = async function(){
  const state = snapshotState();
  const enc   = encodeURIComponent(JSON.stringify(state));
  const url   = new URL(location.href.split("?")[0]);
  url.searchParams.set("present","1");
  url.searchParams.set("state",enc);

  try{
    await navigator.clipboard.writeText(url.toString());
    showToast("‚úÖ Link copiato!");
  }catch(e){
    console.warn("Clipboard non disponibile", e);
    prompt("Copia manualmente:", url.toString());
  }
};

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2000);
}
</script>
</body>
</html>
