<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Corine ‚Äì distretti & palette</title>

<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.33/"></script>

<!-- TopoJSON come ES Module -->
<script type="module">
  import * as topojson from "https://cdn.jsdelivr.net/npm/topojson-client@3/+esm";
  window.topojsonClient = topojson;
</script>

<style>
  html,body,#viewDiv{height:100%;margin:0}
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* ===== Pannello layer (sinistra) ===== */
  #panel{position:absolute;top:10px;left:10px;z-index:20;background:#fff;padding:12px;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.2);font-size:14px;max-width:520px;max-height:92%;overflow:auto}
  #panel.collapsed{display:none}
  #panelToggle{position:absolute;top:10px;left:10px;z-index:21;border:none;border-radius:10px;background:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.2);width:40px;height:40px;cursor:pointer;font-size:18px}

  .row{display:flex;gap:8px;align-items:center;margin:.5rem 0}
  .grow{flex:1}
  .muted{color:#666}
  button,select,input{font:inherit}
  input[type="range"]{width:100%}
  #log{font-size:12px;max-height:150px;overflow:auto;margin-top:6px}

  .card{border:1px solid #e5e7eb;border-radius:10px;background:#fafafa;padding:10px;margin-top:10px}
  .card h4{margin:.2rem 0 .6rem 0;font-size:14px}

  /* lista file server */
  #serverWrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
  .srv-item{border:1px solid #e5e7eb;border-radius:10px;padding:8px;background:#fff;display:flex;align-items:center;gap:8px}
  .srv-name{font-weight:600;flex:1}

  /* ===== Pannello palette (destra) ===== */
  #palToggle{position:absolute;left:60px;top:10px;z-index:21;border:none;border-radius:10px;background:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.2);height:40px;padding:0 10px;cursor:pointer}
  #palPanel{position:absolute;right:15px;top:60px;z-index:24;display:none;background:#fff;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.25);padding:12px;max-height:70%;overflow:auto;min-width:460px}
  .pal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px}
  .pal-item{border:1px solid #eee;border-radius:10px;padding:8px;margin-bottom:8px;cursor:pointer}
  .pal-title{display:flex;align-items:center;gap:10px;font-weight:600;margin-bottom:6px}
  .pal-links a{font-size:14px;text-decoration:none;opacity:.8;margin-left:6px}
  .pal-links a:hover{opacity:1}
  .sw-row{display:grid;grid-template-columns:repeat(10,1fr);gap:4px}
  .sw{height:14px;border-radius:3px;border:1px solid #ddd}

  /* Export PNG (in basso a destra) */
  #btnExport{position:absolute;right:15px;bottom:15px;z-index:26;border:none;border-radius:999px;padding:10px 14px;
    background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.3);cursor:pointer}

  /* Basemap picker */
  #bm-toggle{position:absolute;right:70px;bottom:15px;z-index:25;width:42px;height:42px;border-radius:999px;border:none;
    background:#ffffff;box-shadow:0 6px 18px rgba(0,0,0,.3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px}
  #bm-panel{position:absolute;right:70px;bottom:70px;z-index:24;display:none;background:#fff;border-radius:12px;
    box-shadow:0 6px 18px rgba(0,0,0,.25);padding:10px;min-width:220px}
  #bm-panel label{display:block;font-size:12px;color:#555;margin-bottom:4px}

  /* Shuffle globale */
  #btnShuffleGlobal{position:absolute;left:15px;bottom:15px;z-index:26;border:none;border-radius:999px;padding:10px 14px;
    background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.3);cursor:pointer}

  /* Toast click info */
  #toast{position:absolute;bottom:65px;left:15px;z-index:30;background:#111;color:#fff;border-radius:10px;padding:10px 12px;
    box-shadow:0 6px 18px rgba(0,0,0,.4);display:none;max-width:80%}
  #toast button{margin-left:8px;border:none;border-radius:8px;padding:4px 8px;cursor:pointer}

  /* Miglior spacing su schermi stretti */
  @media (max-width: 900px){
    #panel{max-width:92%}
    #palPanel{right:10px;left:10px;min-width:auto}
  }
</style>
</head>
<body>
<div id="viewDiv"></div>

<!-- toggles -->
<button id="panelToggle" title="Mostra/Nascondi pannello">‚ò∞</button>
<button id="palToggle" title="Palette">üé® Palette</button>

<!-- basemap & export -->
<button id="bm-toggle" title="Basemap">üó∫Ô∏è</button>
<div id="bm-panel">
  <label>Mappa di base</label>
  <select id="bm-select">
    <option value="gray-vector">Grigio (vector)</option>
    <option value="topo-vector">Topografica (vector)</option>
    <option value="streets-vector">Strade (vector)</option>
    <option value="satellite">Satellite</option>
    <option value="hybrid">Ibrida</option>
    <option value="oceans">Oceani</option>
    <option value="dark-gray-vector">Grigio scuro (vector)</option>
    <option value="terrain">Terreno</option>
    <option value="osm-standard">OSM Standard</option>
  </select>
</div>
<button id="btnExport" title="Esporta PNG mappa">Export PNG</button>

<!-- shuffle globale -->
<button id="btnShuffleGlobal" title="Rimescola colori di tutti i layer visibili">üé≤ Shuffle</button>

<!-- ===== Pannello layer (sinistra) ===== -->
<div id="panel">
  <div class="row"><strong>Controlli globali</strong></div>
  <div class="row">
    <label class="muted">Campo legenda</label>
    <label><input type="radio" name="globalField" value="group20" checked> group20</label>
    <label><input type="radio" name="globalField" value="group_nac"> group_nac</label>
    <button id="btnApplyGlobalField">Applica ai layer visibili</button>
  </div>
  <div class="row">
    <button id="btnApplyActivePalette">Applica palette attiva ai layer visibili</button>
    <span id="activePalTag" class="muted"></span>
  </div>

  <hr>
  <div class="row"><strong>Layer sul server</strong></div>
  <div id="serverWrap"></div>
  <div class="row">
    <button id="btnLoadSelected">Carica selezionati</button>
    <button id="btnLoadAll">Carica tutti</button>
    <span class="muted grow" style="text-align:right">oppure</span>
  </div>

  <div class="row">
    <input id="fileInput" class="grow" type="file" accept=".topojson,.geojson,.json" multiple>
    <span class="muted">carica GeoJSON/TopoJSON **o** palette JSON</span>
  </div>

  <hr>
  <div><strong>Layer caricati</strong></div>
  <div id="layersWrap"></div>

  <hr>
  <div><strong>Log</strong></div>
  <div id="log"></div>
</div>

<!-- ===== Pannello palette (destra) ===== -->
<div id="palPanel"></div>

<!-- toast -->
<div id="toast"><span id="toastText"></span><button id="btnCopy">Copia</button></div>

<script>
/* =========== FILE server (ora con path espliciti) =========== */
const SERVER_ITEMS = [
  { label:"AVEIRO", path:"AVEIRO.topojson" },
  { label:"BEJA", path:"BEJA.topojson" },
  { label:"BRAGA", path:"BRAGA.topojson" },
  { label:"BRAGANCA", path:"BRAGANCA.topojson" },
  { label:"CASTELO_BRANCO", path:"CASTELO_BRANCO.topojson" },
  { label:"COIMBRA", path:"COIMBRA.topojson" },
  { label:"EVORA", path:"EVORA.topojson" },
  { label:"FARO", path:"FARO.topojson" },
  { label:"GUARDA", path:"GUARDA.topojson" },
  { label:"LEIRIA", path:"LEIRIA.topojson" },
  { label:"LISBOA", path:"LISBOA.topojson" },
  /* Richiesta: Lisboa blocchi */
  { label:"LISBOA_BLOCOS", path:"lisboa_blocos.json" },
  { label:"PORTALEGRE", path:"PORTALEGRE.topojson" },
  { label:"PORTO", path:"PORTO.topojson" },
  { label:"SANTAREM", path:"SANTAREM.topojson" },
  { label:"SETUBAL", path:"SETUBAL.topojson" },
  { label:"VIANA_DO_CASTELO", path:"VIANA_DO_CASTELO.topojson" },
  { label:"VILA_REAL", path:"VILA_REAL.topojson" },
  { label:"VISEU", path:"VISEU.topojson" }
];

/* =========== VARIABILI APP =========== */
let PALETTES = {};              // nome -> {name, colors:{1..20:"#hex"}, links?}
let ACTIVE_PALETTE_NAMES = [];
let activePaletteName = null;
const LAYERS = [];              // [{layer,title,groupField,opacity,override,basePalette,visible}]
let map, view;

/* =========== MAPPA 2D =========== */
require(["esri/Map","esri/views/MapView","esri/layers/GeoJSONLayer"], function(EsriMap,MapView,GeoJSONLayer){

  map = new EsriMap({ basemap:"gray-vector" });
  view = new MapView({ container:"viewDiv", map, center:[-8,39.5], zoom:7 });
  view.ui.move("zoom","top-right");

  /* Pannelli */
  var panel = document.getElementById("panel");
  document.getElementById("panelToggle").onclick = function(){ panel.classList.toggle("collapsed"); };
  var palPanel = document.getElementById("palPanel");
  document.getElementById("palToggle").onclick = function(){
    palPanel.style.display = (palPanel.style.display==="block"?"none":"block");
  };

  /* Basemap */
  var btnBM = document.getElementById("bm-toggle");
  var pnlBM = document.getElementById("bm-panel");
  var selBM = document.getElementById("bm-select");
  btnBM.onclick = function(){ pnlBM.style.display = (!pnlBM.style.display || pnlBM.style.display==="none")?"block":"none"; };
  selBM.onchange = function(){ map.basemap = selBM.value; };

  /* Export PNG */
  document.getElementById("btnExport").onclick = async function(){
    try{
      var shot = await view.takeScreenshot({ format:"png", quality: 100 });
      var a = document.createElement("a");
      a.href = shot.dataUrl;
      a.download = "map_"+new Date().toISOString().replace(/[:.]/g,"-")+".png";
      a.click();
    }catch(e){ log("Errore export PNG: "+e.message,"err"); }
  };

  /* Toast su click */
  var toast = document.getElementById("toast");
  var toastText = document.getElementById("toastText");
  document.getElementById("btnCopy").onclick = async function(){
    try{ await navigator.clipboard.writeText(toastText.textContent||""); toast.style.display="none"; log("Copiato negli appunti","ok"); }
    catch(e){ log("Copy fallita","err"); }
  };
  view.on("click", async function(event){
    try{
      var hit = await view.hitTest(event);
      var g = hit.results && hit.results.find(function(r){ return r.graphic && r.graphic.layer && r.graphic.layer.type==="geojson"; });
      if(!g){ toast.style.display="none"; return; }
      var entry = LAYERS.find(function(x){ return x.layer===g.graphic.layer; });
      if(!entry){ toast.style.display="none"; return; }
      var attrs = g.graphic.attributes || {};
      var field = entry.groupField;
      var val = attrs[field];
      var rend = entry.layer.renderer;
      var hex = "#000000";
      if(rend && rend.uniqueValueInfos){
        var it = rend.uniqueValueInfos.find(function(u){ return String(u.value)===String(val); });
        if(it && it.symbol && it.symbol.color){
          hex = Array.isArray(it.symbol.color) ? rgbaToHex(it.symbol.color) : it.symbol.color;
        }
      }
      toastText.textContent = "layer: "+entry.title+" | "+field+"="+val+" | color="+hex;
      toast.style.display = "inline-flex";
    }catch(e){}
  });
  function rgbaToHex(c){ var r=c[0]||0,g=c[1]||0,b=c[2]||0; return "#"+[r,g,b].map(function(x){return x.toString(16).padStart(2,"0");}).join(""); }

  /* LOG */
  function log(msg,cls){
    var div=document.getElementById("log");
    var el=document.createElement("div"); if(cls) el.className=cls;
    el.textContent=msg; div.appendChild(el); div.scrollTop=div.scrollHeight;
    if(cls==="err"){ console.error(msg); } else { console.log(msg); }
  }

  /* ====== PALETTE ====== */
  async function loadPalettesFromURL(url){
    try{
      var r = await fetch(url,{cache:"no-store"});
      if(!r.ok) throw new Error("HTTP "+r.status);
      var raw = await r.json();
      mergePalettes(raw);
      buildPaletteGallery();
      updateActivePalTag();
      log("Palette caricate da "+url+": "+ACTIVE_PALETTE_NAMES.length,"ok");
    }catch(e){
      log("Impossibile caricare "+url+" (nessuna palette iniziale)","err");
    }
  }

  function mergePalettes(raw){
    var out = Object.assign({}, PALETTES);
    function add(name, colors, links){
      var norm={}; for(var i=1;i<=20;i++){ var k=String(i); norm[k] = colors[k] || colors[i]; }
      if(Object.values(norm).some(function(v){return !v;})) return;
      out[name] = { name:name, colors:norm, links: links || null };
    }
    if(Array.isArray(raw && raw.palettes)){
      raw.palettes.forEach(function(p){ add(p.name||"Senza nome", p.colors||{}, p.links||null); });
    }else if(raw && typeof raw==="object"){
      Object.keys(raw).forEach(function(name){
        var p = raw[name];
        add(name, (p && p.colors) || {}, p && p.links);
      });
    }
    PALETTES = out;
    ACTIVE_PALETTE_NAMES = Object.keys(out).sort();
    if(!activePaletteName) activePaletteName = ACTIVE_PALETTE_NAMES[0] || null;
  }

  function buildPaletteGallery(){
    var panel = document.getElementById("palPanel");
    panel.innerHTML = "";
    var head = document.createElement("div");
    head.className="pal-head";
    head.innerHTML =
      "<h4 style='margin:0'>Palette disponibili</h4>" +
      "<div style='display:flex;gap:8px;align-items:center'>" +
        "<button id='btnApplyActiveFromGallery'>Applica palette attiva ai layer visibili</button>" +
        "<input id='palFile' type='file' accept='.json' title='Carica file palette JSON' />" +
      "</div>";
    panel.appendChild(head);
    document.getElementById("btnApplyActiveFromGallery").onclick = applyActivePaletteToVisible;

    var palFile = document.getElementById("palFile");
    palFile.onchange = async function(ev){
      var f = palFile.files && palFile.files[0];
      if(!f) return;
      try{
        var txt = await f.text();
        var obj = JSON.parse(txt);
        mergePalettes(obj);
        buildPaletteGallery();
        updateActivePalTag();
        log("Palette aggiunte da file: "+f.name,"ok");
      }catch(e){
        log("Errore palette JSON: "+e.message,"err");
      }
      palFile.value = "";
    };

    ACTIVE_PALETTE_NAMES.forEach(function(name){
      var p = PALETTES[name];
      var div=document.createElement("div"); div.className="pal-item"; div.title="Imposta e applica \""+name+"\"";
      var title=document.createElement("div"); title.className="pal-title";

      var titleText = document.createElement("div");
      titleText.textContent = name;

      var linksWrap = document.createElement("div");
      linksWrap.className = "pal-links";
      if(p.links){
        if(p.links.google_images){ var a=document.createElement("a"); a.href=p.links.google_images; a.target="_blank"; a.title="Google Images"; a.textContent="üîç"; linksWrap.appendChild(a); }
        if(p.links.wikipedia){ var a2=document.createElement("a"); a2.href=p.links.wikipedia; a2.target="_blank"; a2.title="Wikipedia"; a2.textContent="üìñ"; linksWrap.appendChild(a2); }
        if(p.links.google_arts_culture){ var a3=document.createElement("a"); a3.href=p.links.google_arts_culture; a3.target="_blank"; a3.title="Google Arts & Culture"; a3.textContent="üèõÔ∏è"; linksWrap.appendChild(a3); }
        if(p.links.wikiart){ var a4=document.createElement("a"); a4.href=p.links.wikiart; a4.target="_blank"; a4.title="WikiArt"; a4.textContent="üé®"; linksWrap.appendChild(a4); }
      }

      title.appendChild(titleText);
      title.appendChild(linksWrap);

      var sw1=document.createElement("div"); sw1.className="sw-row";
      var sw2=document.createElement("div"); sw2.className="sw-row";
      for(var i=1;i<=10;i++){ var c1=document.createElement("div"); c1.className="sw"; c1.style.background=p.colors[String(i)]; sw1.appendChild(c1); }
      for(var j=11;j<=20;j++){ var c2=document.createElement("div"); c2.className="sw"; c2.style.background=p.colors[String(j)]; sw2.appendChild(c2); }

      div.appendChild(title); div.appendChild(sw1); div.appendChild(sw2);
      div.onclick = function(){
        activePaletteName = name;
        updateActivePalTag();
        applyActivePaletteToVisible();
      };
      panel.appendChild(div);
    });
  }

  function updateActivePalTag(){
    document.getElementById("activePalTag").textContent = activePaletteName ? ("Palette attiva: "+activePaletteName) : "(nessuna palette attiva)";
  }

  /* ====== RENDERER ====== */
  function buildRenderer(field, palette, override){
    var infos = [];
    var maxRank = 20;
    for(var i=1;i<=maxRank;i++){
      var invRank = maxRank - i + 1; /* classe grande -> colore 1 */
      var hex = "#cccccc";
      if(override && override[String(invRank)]) hex = override[String(invRank)];
      else if(palette && palette.colors) hex = palette.colors[String(invRank)] || palette.colors[invRank];
      infos.push({
        value: i,
        symbol: { type:"simple-fill", color: hex, outline: { color:[0,0,0,0], width:0 } },
        label: "Classe "+i
      });
    }
    return {
      type:"unique-value",
      field: field,
      defaultSymbol: { type:"simple-fill", color:[220,220,220,0], outline:{color:[0,0,0,0],width:0} },
      uniqueValueInfos: infos
    };
  }

  function applyPalette(entry){
    if(!entry.groupField){ log(entry.title+": imposta il campo legenda (es. group20 o group_nac)","err"); return; }
    if(!entry.basePalette){
      if(!activePaletteName){ log("Nessuna palette attiva: scegli dalla gallery","err"); return; }
      entry.basePalette = PALETTES[activePaletteName];
    }
    entry.layer.renderer = buildRenderer(entry.groupField, entry.basePalette, entry.override);
    entry.layer.opacity = entry.opacity || 1;
  }

  function shuffleColors(entry){
    if(!entry.basePalette){ log("Imposta una palette per "+entry.title,"err"); return; }
    var ranks = []; for(var i=1;i<=20;i++) ranks.push(String(i));
    var cols = ranks.map(function(r){ return entry.basePalette.colors[r]; });
    for(var k=cols.length-1;k>0;k--){ var j=Math.floor(Math.random()*(k+1)); var tmp=cols[k]; cols[k]=cols[j]; cols[j]=tmp; }
    entry.override = {}; ranks.forEach(function(r,i){ entry.override[r]=cols[i]; });
    applyPalette(entry); updateCardSwatches(entry);
  }
  function resetLayer(entry){
    if(activePaletteName){ entry.basePalette = PALETTES[activePaletteName]; }
    entry.override = null; applyPalette(entry); updateCardSwatches(entry);
  }
  function applyActivePaletteToVisible(){
    if(!activePaletteName){ log("Seleziona prima una palette nella gallery","err"); return; }
    var p = PALETTES[activePaletteName];
    LAYERS.filter(function(e){return e.visible;}).forEach(function(e){
      e.basePalette = p; e.override=null; applyPalette(e); updateCardSwatches(e);
    });
    refreshLayerCards();
  }

  /* ====== CARICAMENTO layer ====== */
  async function addFromGeoJSONObject(obj, titleBase){
    var blob = new Blob([JSON.stringify(obj)], {type:"application/json"});
    var blobUrl = URL.createObjectURL(blob);
    var layer = new GeoJSONLayer({ url: blobUrl, title: titleBase });
    map.add(layer);
    var entry = { layer:layer, title:titleBase, groupField:null, opacity:1, override:null, basePalette:null, visible:true };
    LAYERS.push(entry);

    layer.when(async function(){
      entry.groupField = await detectGroupField(layer);
      if(activePaletteName) entry.basePalette = PALETTES[activePaletteName];
      applyPalette(entry);
      refreshLayerCards();
      try{ var ex=await layer.queryExtent(); if(ex.extent) view.goTo(ex.extent.expand(1.05)); }catch(e){}
      log("Caricato: "+titleBase,"ok");
    });
  }

  async function addFromPath(path){
    var baseName = path.replace(/^.*[\\/]/,"").replace(/\.[^.]+$/,"");
    try{
      var resp = await fetch(path,{cache:"no-store"});
      if(!resp.ok) throw new Error("HTTP "+resp.status);
      var txt = await resp.text();
      var obj = JSON.parse(txt);

      if(obj.type === "Topology"){
        var names = Object.keys(obj.objects || {}); if(!names.length) throw new Error("TopoJSON senza objects");
        var pick = names[0], maxn = 0;
        for(var n of names){ var g=obj.objects[n]; var cnt=(g && g.geometries || []).length; if(cnt>maxn){maxn=cnt; pick=n;} }
        var geo = window.topojsonClient.feature(obj, obj.objects[pick]);
        await addFromGeoJSONObject(geo, baseName);
      } else {
        var isGeo = obj && ((obj.type==="FeatureCollection" && Array.isArray(obj.features)) || (obj.type==="Feature" && obj.geometry));
        if(!isGeo) throw new Error("Formato non riconosciuto");
        await addFromGeoJSONObject(obj, baseName);
      }
    }catch(e){
      log('Errore "'+path+'": '+e.message,"err");
    }
  }

  async function detectGroupField(layer){
    var prefs = ["group20","group_nac","RANK","group","Rank20"];
    try{
      var q = layer.createQuery(); q.outFields = ["*"]; q.returnGeometry=false; q.num=1;
      var r = await layer.queryFeatures(q);
      if(r.features.length){
        var attrs = r.features[0].attributes;
        for(var k of prefs){ if(k in attrs) return k; }
        var keys = Object.keys(attrs);
        return keys.find(function(k){return k!=="OBJECTID" && k!=="FID";}) || keys[0] || null;
      }
    }catch(e){}
    return null;
  }

  /* ====== UI ‚Äì Server list ====== */
  var serverWrap = document.getElementById("serverWrap");
  var nameToEntry = new Map();

  function initServerList(){
    serverWrap.innerHTML = "";
    SERVER_ITEMS.forEach(function(item){
      var name = item.label, path = item.path;
      var div = document.createElement("div"); div.className="srv-item";
      var cb = document.createElement("input"); cb.type="checkbox"; cb.value=path;
      var lbl = document.createElement("div"); lbl.className="srv-name"; lbl.textContent = name.replace(/_/g," ");
      div.appendChild(cb); div.appendChild(lbl); serverWrap.appendChild(div);

      cb.onchange = async function(){
        var entry = nameToEntry.get(path);
        if(cb.checked){
          if(entry){ entry.visible=true; entry.layer.visible=true; refreshLayerCards(); }
          else { await addFromPath(path); nameToEntry.set(path, LAYERS[LAYERS.length-1]); }
        }else{
          if(entry){ entry.visible=false; entry.layer.visible=false; refreshLayerCards(); }
        }
      };
    });

    document.getElementById("btnLoadSelected").onclick = async function(){
      var checks = Array.prototype.slice.call(serverWrap.querySelectorAll('input[type="checkbox"]'));
      var picked = checks.filter(function(x){return x.checked;}).map(function(x){return x.value;});
      if(!picked.length){
        log("Nessun layer selezionato: attivo e carico tutti","ok");
        await loadAllServerLayers(checks);
      }else{
        for(var n of picked){
          var cb = checks.find(function(x){return x.value===n;}); if(cb) cb.checked = true;
          var entry = nameToEntry.get(n);
          if(entry){ entry.visible=true; entry.layer.visible=true; refreshLayerCards(); }
          else { await addFromPath(n); nameToEntry.set(n, LAYERS[LAYERS.length-1]); }
        }
      }
    };

    document.getElementById("btnLoadAll").onclick = async function(){
      var checks = Array.prototype.slice.call(serverWrap.querySelectorAll('input[type="checkbox"]'));
      await loadAllServerLayers(checks);
    };
  }

  async function loadAllServerLayers(checks){
    for(var cb of checks){ cb.checked = true; }
    for(var it of SERVER_ITEMS){
      var path = it.path;
      var entry = nameToEntry.get(path);
      if(entry){ entry.visible=true; entry.layer.visible=true; refreshLayerCards(); }
      else { await addFromPath(path); nameToEntry.set(path, LAYERS[LAYERS.length-1]); }
    }
  }

  /* ====== UI ‚Äì File locali (Geo/Topo/PAL) ====== */
  document.getElementById("fileInput").addEventListener("change", async function(ev){
    var files = ev.target.files;
    for(var i=0;i<files.length;i++){
      var f = files[i];
      try{
        var txt = await f.text();
        var obj = JSON.parse(txt);

        /* Se ha struttura "palette", fondi dentro PALETTES */
        if(obj && (Array.isArray(obj.palettes) || (typeof obj==="object" && Object.values(obj)[0] && Object.values(obj)[0].colors))){
          mergePalettes(obj);
          buildPaletteGallery();
          updateActivePalTag();
          log("Palette aggiunte da file: "+f.name,"ok");
          continue;
        }

        /* Altrimenti prova come Geo/Topo */
        var base = f.name.replace(/\.[^.]+$/,"");
        if(obj.type==="Topology"){
          var names = Object.keys(obj.objects || {}); if(!names.length){ log("TopoJSON senza objects: "+f.name,"err"); continue; }
          var pick = names[0], maxn=0;
          for(var n of names){ var g=obj.objects[n]; var cnt=(g && g.geometries || []).length; if(cnt>maxn){maxn=cnt; pick=n;} }
          var geo = window.topojsonClient.feature(obj, obj.objects[pick]);
          await addFromGeoJSONObject(geo, base);
        } else {
          var isGeo = obj && ((obj.type==="FeatureCollection" && Array.isArray(obj.features)) || (obj.type==="Feature" && obj.geometry));
          if(!isGeo){ log('"'+f.name+'" non √® GeoJSON/TopoJSON/palette valido','err'); continue; }
          await addFromGeoJSONObject(obj, base);
        }
      }catch(e){
        log("Errore file "+f.name+": "+e.message,"err");
      }
    }
    ev.target.value = "";
  });

  /* ====== UI ‚Äî Layer cards ====== */
  var layersWrap = document.getElementById("layersWrap");
  function refreshLayerCards(){
    layersWrap.innerHTML = "";
    LAYERS.forEach(function(entry, idx){
      var card = document.createElement("div"); card.className="card";
      card.innerHTML =
        "<h4>"+entry.title+"</h4>"+
        "<div class='row'>"+
          "<label class='muted' style='width:90px'>Visibile</label>"+
          "<input type='checkbox' id='vis-"+idx+"' "+(entry.visible?"checked":"")+">"+
          "<label class='muted' style='margin-left:12px;width:110px'>Campo legenda</label>"+
          "<input id='gf-"+idx+"' class='grow' type='text' value='"+(entry.groupField||"")+"' placeholder='group20 o group_nac'>"+
        "</div>"+
        "<div class='row'>"+
          "<label class='muted' style='width:90px'>Trasparenza</label>"+
          "<input id='op-"+idx+"' type='range' min='0' max='1' step='0.05' value='"+(entry.opacity||1)+"'>"+
        "</div>"+
        "<div class='row' style='gap:6px'>"+
          "<button id='btnShuffle-"+idx+"'>üé≤ Shuffle</button>"+
          "<button id='btnReset-"+idx+"'>Reset</button>"+
          "<button id='btnRemove-"+idx+"'>Rimuovi</button>"+
        "</div>"+
        "<div class='row'><span class='muted' id='paletteSw-"+idx+"'></span></div>";
      layersWrap.appendChild(card);

      var vis = card.querySelector("#vis-"+idx);
      vis.onchange = function(){ entry.visible = vis.checked; entry.layer.visible = entry.visible; };

      var gf = card.querySelector("#gf-"+idx);
      gf.onchange = function(){ entry.groupField = gf.value.trim(); applyPalette(entry); updateCardSwatches(entry); };

      var op = card.querySelector("#op-"+idx);
      op.oninput = function(){ entry.opacity = Number(op.value); entry.layer.opacity = entry.opacity; };

      card.querySelector("#btnShuffle-"+idx).onclick = function(){ shuffleColors(entry); };
      card.querySelector("#btnReset-"+idx).onclick   = function(){ resetLayer(entry); };
      card.querySelector("#btnRemove-"+idx).onclick  = function(){
        map.remove(entry.layer);
        var k = LAYERS.indexOf(entry); if(k>=0) LAYERS.splice(k,1);
        refreshLayerCards();
      };

      updateCardSwatches(entry);
    });
  }

  function updateCardSwatches(entry){
    var k = LAYERS.indexOf(entry);
    var el = document.getElementById("paletteSw-"+k);
    if(!el) return;
    if(!(entry.basePalette || activePaletteName)){ el.textContent="(nessuna palette assegnata)"; return; }
    var base = entry.basePalette || PALETTES[activePaletteName];
    var pal = entry.override ? {colors: entry.override} : base;
    var wrap = document.createElement("span");
    for(var i=1;i<=20;i++){
      var hex = pal.colors[String(i)];
      var s = document.createElement("span");
      s.title = i+":"+hex;
      s.style.cssText = "display:inline-block;width:10px;height:10px;border:1px solid #ccc;margin-left:2px;background:"+hex+";vertical-align:middle;border-radius:2px";
      wrap.appendChild(s);
    }
    el.innerHTML = "Palette: <strong>"+((entry.basePalette && entry.basePalette.name) || activePaletteName)+"</strong> "+wrap.outerHTML;
  }

  /* Shuffle globale */
  document.getElementById("btnShuffleGlobal").onclick = function(){
    var vis = LAYERS.filter(function(e){return e.visible;});
    if(!vis.length){ log("Nessun layer visibile","err"); return; }
    vis.forEach(function(e){ shuffleColors(e); });
    refreshLayerCards();
  };

  /* Controllo globale campo legenda */
  document.getElementById("btnApplyGlobalField").onclick = async function(){
    var sel = (document.querySelector('input[name="globalField"]:checked')||{}).value || "group20";
    var vis = LAYERS.filter(function(x){return x.visible;});
    if(!vis.length){ log("Nessun layer visibile","err"); return; }
    for(var e of vis){
      var ok = await fieldExists(e.layer, sel);
      if(ok){ e.groupField = sel; applyPalette(e); }
      else { log(e.title+': campo "'+sel+'" non presente (lasciato invariato)',"err"); }
    }
    refreshLayerCards();
  };

  document.getElementById("btnApplyActivePalette").onclick = applyActivePaletteToVisible;

  async function fieldExists(layer, fname){
    try{
      var q = layer.createQuery(); q.outFields=["*"]; q.returnGeometry=false; q.num=1;
      var r = await layer.queryFeatures(q);
      if(r.features.length){ return Object.prototype.hasOwnProperty.call(r.features[0].attributes, fname); }
    }catch(e){}
    return false;
  }

  /* ======= Init ======= */
  initServerList();
  /* carico palette di default dal file rinominato */
  loadPalettesFromURL("./palette_from_tbw.json");

}); /* require */
</script>
</body>
</html>
