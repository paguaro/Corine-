<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Test GeoJSON – load hardcoded</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.33/"></script>
<style>
  html,body,#viewDiv { height:100%; margin:0 }
  #log {
    position:absolute; top:10px; left:10px; z-index:10;
    background:#fff; padding:10px; border-radius:8px;
    font-family:system-ui,sans-serif; font-size:13px; min-width:320px;
    box-shadow:0 2px 8px rgba(0,0,0,.2)
  }
  #log .ok { color:#166534 }   /* verde */
  #log .err{ color:#b91c1c }   /* rosso */
  #log code{ background:#f3f4f6; padding:1px 4px; border-radius:4px }
</style>
</head>
<body>
<div id="viewDiv"></div>
<div id="log">Avvio…</div>

<script>
const GEOJSON_PATH = "./CLC2012_Export_FeaturesToJSO.geojson"; // << hardcoded nella root

require(["esri/Map","esri/views/MapView","esri/layers/GeoJSONLayer"], (Map,MapView,GeoJSONLayer) => {
  const log = (html, cls="") => {
    const div = document.getElementById("log");
    div.innerHTML = `<div class="${cls}">${html}</div>` + div.innerHTML;
  };

  // mappa
  const map = new Map({ basemap:"gray-vector" });
  const view = new MapView({ container:"viewDiv", map, center:[-8,39.5], zoom:6 });

  // 1) prova fetch del file per validare percorso e formato
  log(`Provo a caricare <code>${GEOJSON_PATH}</code>…`);
  fetch(GEOJSON_PATH, { cache:"no-store" })
    .then(async r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} – ${r.statusText}`);
      const txt = await r.text();
      let obj;
      try { obj = JSON.parse(txt); }
      catch(e){ throw new Error("Il file esiste ma NON è JSON valido."); }

      // controlli minimi GeoJSON
      const isFC = obj && obj.type === "FeatureCollection" && Array.isArray(obj.features);
      const isF  = obj && obj.type === "Feature" && obj.geometry;
      if (!isFC && !isF) {
        throw new Error("JSON trovato ma non è GeoJSON (manca FeatureCollection/Feature).");
      }
      log("Fetch OK e JSON valido ✔️", "ok");

      // 2) crea layer da Blob (evita problemi di MIME su Pages)
      const blob = new Blob([JSON.stringify(obj)], { type:"application/json" });
      const url  = URL.createObjectURL(blob);

      const layer = new GeoJSONLayer({ url, title: "Dataset hardcoded", outFields:["*"] });
      map.add(layer);

      layer.when()
        .then(async () => {
          log("GeoJSONLayer caricato ✔️", "ok");
          // centra sulla geometria
          try {
            const q = layer.createQuery(); q.returnGeometry = true;
            const res = await layer.queryExtent(q);
            if (res && res.extent) view.goTo(res.extent.expand(1.05));
          } catch(e){ /* ok */ }
        })
        .catch(e => {
          console.error(e);
          log("GeoJSONLayer NON caricato (formato o CRS non supportato).", "err");
        });
    })
    .catch(err => {
      console.error(err);
      log(`Errore nel fetch: ${err.message}<br>Controlla che il file sia davvero in root con quel nome esatto.`, "err");
    });
});
</script>
</body>
</html>
