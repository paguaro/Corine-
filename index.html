<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CLC – Mona Lisa palette</title>
<link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">
<script src="https://js.arcgis.com/4.33/"></script>
<style>
  html, body, #viewDiv { height: 100%; margin: 0; }
  #panel {
    position:absolute; top:10px; left:10px; z-index:10; background:#fff; padding:10px;
    border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.15);
    font-family: system-ui, sans-serif; font-size:14px;
  }
  #legendDiv {
    position:absolute; bottom:10px; left:10px; z-index:10; background:#fff; padding:8px 10px;
    border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15);
  }
  .badge {
    display:inline-block; padding:2px 6px; border-radius:4px;
    background:#eef; margin-left:6px; font-size:12px;
  }
</style>
</head>
<body>
<div id="viewDiv"></div>
<div id="panel">
  <div><strong>File:</strong> CLC2012_Export_FeaturesToJSO.geojson</div>
  <div><strong>Campo gruppo:</strong> group_20 <span id="grpCount" class="badge"></span></div>
  <div><strong>Palette:</strong> Mona Lisa (20 colori)</div>
  <button id="btnApply" style="margin-top:6px;">Applica / Ricalcola aree</button>
</div>
<div id="legendDiv"></div>

<script>
  // Percorso relativo al file GeoJSON
  const GEOJSON_URL = "./CLC2012_Export_FeaturesToJSO.geojson";
  const GROUP_FIELD = "group_20";

  // Palette Mona Lisa
  const PALETTE = {
    "1": "#a35a16","2": "#7d3f10","3": "#f1b837","4": "#312914","5": "#805835",
    "6": "#d3b04c","7": "#2e110d","8": "#cd6b14","9": "#6a6548","10": "#7f6d2d",
    "11": "#644600","12": "#52461e","13": "#e39226","14": "#973613","15": "#6c2415",
    "16": "#ffdf5a","17": "#0f0506","18": "#a58936","19": "#606d35","20": "#4d2212"
  };

  let view, layer, geometryEngine;

  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/GeoJSONLayer",
    "esri/widgets/Legend",
    "esri/geometry/geometryEngine"
  ], (Map, MapView, GeoJSONLayer, Legend, gEngine) => {
    geometryEngine = gEngine;

    const map = new Map({ basemap: "gray-vector" });
    view = new MapView({ container: "viewDiv", map });

    layer = new GeoJSONLayer({
      url: GEOJSON_URL,
      outFields: ["*"],
      title: "CLC (20 gruppi)"
    });
    map.add(layer);

    new Legend({ view, container: "legendDiv" });

    view.whenLayerView(layer).then(() => {
      fitToLayer();
      applyRenderer();
    });

    document.getElementById("btnApply").addEventListener("click", applyRenderer);
  });

  async function fitToLayer() {
    try {
      const q = layer.createQuery();
      q.returnGeometry = true;
      const res = await layer.queryExtent(q);
      if (res && res.extent) view.goTo(res.extent.expand(1.05));
    } catch(e) { console.warn(e); }
  }

  async function applyRenderer() {
    const q = layer.createQuery();
    q.returnGeometry = true;
    q.outFields = [GROUP_FIELD];
    q.outSpatialReference = { wkid: 4326 };
    const res = await layer.queryFeatures(q);

    const areas = new Map();
    for (const f of res.features) {
      const gid = f.attributes[GROUP_FIELD];
      const a = Math.abs(geometryEngine.geodesicArea(f.geometry, "square-meters")) || 0;
      areas.set(gid, (areas.get(gid) || 0) + a);
    }

    const entries = Array.from(areas.entries()).sort((a,b) => b[1]-a[1]);
    const n = entries.length;
    const rankByGroup = new Map();
    entries.forEach(([gid], i) => rankByGroup.set(gid, n - i));

    const infos = entries.map(([gid]) => {
      const rank = rankByGroup.get(gid);
      const hex = PALETTE[String(rank)] || "#cccccc";
      return {
        value: gid,
        label: `Gruppo ${gid} (rank ${rank})`,
        symbol: { type: "simple-fill", color: hex, outline: { color: [0,0,0,40], width: 0.25 } }
      };
    });

    layer.renderer = {
      type: "unique-value",
      field: GROUP_FIELD,
      uniqueValueInfos: infos,
      legendOptions: { title: "CLC – Mona Lisa (rank per area)" }
    };

    const el = document.getElementById("grpCount");
    if (el) el.textContent = `${n} gruppi visibili`;
  }
</script>
</body>
</html>
